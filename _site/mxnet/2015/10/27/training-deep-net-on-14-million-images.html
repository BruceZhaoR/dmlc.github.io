<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Training Deep Net on 14 Million Images by Using A Single Machine</title>
  <meta name="description" content="This blog describes how to train a neural network on Full ImageNet Dataset [1]with 14,197,087 images in 21,841 classes. We achieved a state-of-art model byus...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://dmlc.ml/mxnet/2015/10/27/training-deep-net-on-14-million-images.html">
  <link rel="alternate" type="application/rss+xml" title="DMLC" href="http://dmlc.ml/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/"> DMLC </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Training Deep Net on 14 Million Images by Using A Single Machine</h1>
    <p class="post-meta"><time datetime="2015-10-27T17:40:42-04:00" itemprop="datePublished">Oct 27, 2015</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Bing Xu</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This blog describes how to train a neural network on Full ImageNet Dataset [1]
with 14,197,087 images in 21,841 classes. <strong>We achieved a state-of-art model by
using 4 GeForce GTX 980 cards on a single machine in 8.5 days.</strong></p>

<p>There are several technical challenges in this problem.</p>

<ol>
  <li>How to pack and store the massive data.</li>
  <li>How to minimize the memory consumption of the network, so we can use net with more capacity than those used for ImageNet 1K</li>
  <li>How to train the model fast.</li>
</ol>

<p>We also released our pre-trained model for this full ImageNet dataset.</p>

<h2 id="data-preprocessing">Data Preprocessing</h2>
<p>The raw full ImageNet dataset is more than 1TB. Before training the network, we need to shuffle these images then load batch of images to feed the neural network. Before we describe how we solve it, let’s do some calculation first:</p>

<p>Assume we have two good storage device [2]:</p>

<table>
  <thead>
    <tr>
      <th>Device</th>
      <th>4K Random Seek</th>
      <th>Sequential Seek</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WD Black (HDD)</td>
      <td>0.43 MB /s (110 IOPS)</td>
      <td>170 MB/s</td>
    </tr>
    <tr>
      <td>Samsung 850 PRO (SSD)</td>
      <td>40 MB/s (10,000 IOPS)</td>
      <td>550 MB/s</td>
    </tr>
  </tbody>
</table>

<p>A very naive approach is loading from a list by random seeking. If use this approach, we will spend 677 hours with HDD or 6.7 hours with SSD respectively. This is only about read. Although SSD looks not bad, but 1TB SSD is not affordable for everyone.</p>

<p>But we notice sequential seek is much faster than random seek. Also, loading batch by batch is a sequential action. Can we make a change? The answer is we can’t do sequential seek directly. We need random shuffle the training data first, then pack them into a sequential binary package.</p>

<p>This is the normal solution used by most deep learning packages. However, unlike ImageNet 1K dataset, where we <strong><em>cannot</em></strong> store the images in raw pixels format.  Because otherwise we will need more than 1TB space. Instead, we need to pack the images in compressed format.</p>

<p><strong><em>The key ingredients are</em></strong></p>

<ul>
  <li>Store the images in jpeg format, and pack them into binary record.</li>
  <li>Split the list, and pack several record files, instead of one file.
    <ul>
      <li>This allows us to pack the images in distributed fashion, because we will be eventually bounded by the IO cost during packing.</li>
      <li>We need to make the package being able to read from several record files, which is not too hard.
This will allow us to store the entire imagenet dataset in around 250G space.</li>
    </ul>
  </li>
</ul>

<p>After packing, together with threaded buffer iterator, we can simply achieve an IO speed of around 3,000 images/sec on a normal HDD.</p>

<h2 id="training-the-model">Training the model</h2>

<p>Now we have data. We need to consider which network structure to use. We use
Inception-BN [3] style model, compared to other models such as VGG, it has fewer
parameters, less parameters simplified sync problem. Considering our problem is
much more challenging than 1k classes problem, we add suitable capacity into
original Inception-BN structure, by increasing the size of filter by factor of
1.5 in bottom layers of original Inception-BN network.  This however, creates a
challenge for GPU memory. As GTX980 only have 4G of GPU RAM. We really need to
minimize the memory consumption to fit larger batch-size into the training. To
solve this problem we use the techniques such as node memory reuse, and inplace
optimization, which reduces the memory consumption by half, more details can be
found in
<a href="http://mxnet.readthedocs.org/en/latest/developer-guide/note_memory.html">memory optimization note</a></p>

<p>Finally, we cannot train the model using a single GPU because this is a really
large net, and a lot of data. We use data parallelism on four GPUs to train this
model, which involves smart synchronization of parameters between different
GPUs, and overlap the communication and computation. A
<a href="https://mxnet.readthedocs.org/en/latest/developer-guide/note_engine.html">runtime denpdency engine</a>
is used to simplify this task, allowing us to run the training at around 170
images/sec.</p>

<p>Here is a learning cureve of the training process:
<img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/imagenet_full/curve.png" alt="alt text" title="Learning Curve" /></p>

<h2 id="evaluate-the-performance">Evaluate the Performance</h2>
<p>Train Top-1 Accuracy over 21,841 classes: 37.19%</p>

<p>There is no official validation set over 21,841 classes, so we are using ILVRC2012 validation set to check the performance. Here is the result:</p>

<table>
  <thead>
    <tr>
      <th>Accuracy</th>
      <th>Over 1,000 classes</th>
      <th>Over 21,841 classes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Top-1</td>
      <td>68.3%</td>
      <td>41.9%</td>
    </tr>
    <tr>
      <td>Top-5</td>
      <td>89.0%</td>
      <td>69.6%</td>
    </tr>
    <tr>
      <td>Top=20</td>
      <td>96.0%</td>
      <td>83.6%</td>
    </tr>
  </tbody>
</table>

<p>As we can see we get quite reasonable result after 9 iterations. Notably much less number of iterations is needed to achieve a stable performance, mainly due to we are facing a larger dataset.</p>

<p>We should note that this result is by no means optimal, as we did not carefully pick the parameters and the experiment cycle is longer than the 1k dataset. We think there is definite space for improvement, and you are welcomed to try it out by yourself!</p>

<h2 id="the-code-and-model">The Code and Model</h2>
<p>The code and step guide is publically available at <a href="https://github.com/dmlc/mxnet/tree/master/example/imagenet">https://github.com/dmlc/mxnet/tree/master/example/imagenet</a></p>

<p>We also release a pretrained model under <a href="https://github.com/dmlc/mxnet-model-gallery/tree/master/imagenet-21k-inception">https://github.com/dmlc/mxnet-model-gallery/tree/master/imagenet-21k-inception</a></p>

<h2 id="how-to-use-the-model">How to Use The Model</h2>
<p>We should point out it 21k classes is much more challenging than 1k. Directly use the raw prediction is not a reasonable way.</p>

<p>Look at this picture which I took in Mount Rainier this summer:</p>

<p><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/imagenet_full/rainier.png" alt="alt text" title="Mount Rainer" /></p>

<p>We can figure out there is a mountain, valley, tree and bridge. And the prediction probability is :</p>

<p><img src="https://raw.githubusercontent.com/dmlc/web-data/master/mxnet/imagenet_full/prob.png" alt="alt text" title="Probability" /></p>

<p>We notice there are several peaks. Let’s print out the label text in among 21k classes and ImageNet 1k classes:</p>

<table>
  <thead>
    <tr>
      <th>Rank</th>
      <th>Over 1,000 classes</th>
      <th>Over 21,841 classes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Top-1</td>
      <td>n09468604 valley</td>
      <td>n11620673 Fir</td>
    </tr>
    <tr>
      <td>Top-2</td>
      <td>n09332890 lakeside</td>
      <td>n11624531 Spruce</td>
    </tr>
    <tr>
      <td>Top-3</td>
      <td>n04366367 suspension bridge</td>
      <td>n11621281 Amabilis fir</td>
    </tr>
    <tr>
      <td>Top-4</td>
      <td>n09193705 alp</td>
      <td>n11628456 Douglas fir</td>
    </tr>
    <tr>
      <td>Top-5</td>
      <td>n09428293 seashore</td>
      <td>n11627908 Mountain hemlock</td>
    </tr>
  </tbody>
</table>

<p>There is no doubt that directly use probability over 21k classes loss diversity of prediction. If you carefully choose a subset by using WordNet hierarchy relation, I am sure you will find more interesting results.</p>

<h2 id="references">References</h2>
<p>[1] Deng, Jia, et al. “Imagenet: A large-scale hierarchical image database.” <em>Computer Vision and Pattern Recognition</em>, 2009. CVPR 2009. IEEE Conference on. IEEE, 2009.</p>

<p>[2] HDD/SSD data is from public website may not be accurate.</p>

<p>[3] Ioffe, Sergey, and Christian Szegedy. “Batch normalization: Accelerating deep network training by reducing internal covariate shift.” <em>arXiv preprint arXiv:1502.03167</em> (2015).</p>

  </div>

</article>

      </div>
    </div>

    


    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">DMLC</h2>

    <div class="footer-col-wrapper">
      <!-- <div class="footer-col footer-col-1"> -->
      <!--   <ul class="contact-list"> -->
      <!--     <li>DMLC</li> -->
      <!--     <li><a href="mailto:muli.cmu@gmail.com">muli.cmu@gmail.com</a></li> -->
      <!--   </ul> -->
      <!-- </div> -->

      <!-- <div class="footer-col footer-col-2"> -->
      <!--   <ul class="social-media-list"> -->
      <!--      -->

      <!--      -->
      <!--   </ul> -->
      <!-- </div> -->

      <!-- <div class="footer-col footer-col-3"> -->
      <!--   <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p> -->
      <!-- </div> -->
    </div>

  </div>

</footer>


  </body>

</html>
